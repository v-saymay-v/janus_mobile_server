<?php

include ("include/dbconnect.php");
include ("include/format.inc.php");
include ("include/photo.class.php");

if ($submit || $update) { ?>
  <meta HTTP-EQUIV="REFRESH" content="3;url=.">
<?php
}

$resultsnumber = 0;
if ($id) {

  $sql = "SELECT $base_select FROM $base_from_where AND $table.n_card='$id'";
  $result = mysqli_query($db,$sql);
  if (!$result) {
    error_log("sql error = " . mysqli_error($db));
  }
  $r = mysqli_fetch_array($result);

  $resultsnumber = mysqli_num_rows($result);
}

if( ($resultsnumber == 0 && !isset($all)) || (!$id && !isset($all))) {
?>
  <title>Address book <?php echo ($group_name != "" ? "($group_name)":""); ?></title>
<?php
  include ("include/header.inc.php");
} else {
?>
  <title><?php echo $r["lastname"].(isset($r['middlename']) ? " ".$r['middlename']:"")." ".$r["firstname"]." ".($group_name != "" ? "($group_name)":"")."\n"; ?></title>
<?php
  if( !isset($_GET["print"]))
  {
    include ("include/header.inc.php");
  } else {
    echo '</head><body>';
    // echo '</head><body onload="javascript:window.setTimeout(window.print(self), 1000)";>';
  }
}
?>
 <h1><?php echo ucfmsg('EDIT_ADD_ENTRY'); ?></h1>
<?php
if ($submit)
{
  if (! $read_only)
  {
  //
  // Primitiv filter against spam on "sourceforge.net".
  //
    if ($_SERVER['SERVER_NAME'] == "php-addressbook.sourceforge.net") {

      $spam_test = $firstname.$middlename.$lastname.$address.$home.$mobile.$work.$email.$email2.$email3.$bday.$bmonth.$byear.$aday.$amonth.$ayear.$address2.$phone2;
      $blacklist = array( 'viagra', 'seroquel', 'zovirax', 'ultram', 'mortage', 'loan'
                        , 'accutane', 'ativan', 'gun', 'sex', 'porn', 'arachidonic'
                        , 'recipe', 'comment1'
                        , 'naked', 'gay', 'fetish', 'domina', 'fakes', 'drugs'
                        , 'methylphenidate', 'nevirapine', 'viramune' );
      foreach( $blacklist as $blackitem ) {
        if(strpos(strtolower($spam_test), $blackitem) !== FALSE ) {
          exit;
        }
      }
      if(   preg_match('/\D{3,}/', $home) > 0
        || preg_match('/\D{3,}/', $mobile) > 0) {
          exit;
      }
      if(   strlen($home)   > 15
        || strlen($mobile) > 15) {
          exit;
      }
    }

    $addr['user_id']   = $user_id;
    $addr['firstname'] = $firstname;
    $addr['firstyomi'] = mb_convert_kana(mb_convert_kana($firstyomi), "c");
    $addr['middlename']= $middlename;
    $addr['middleyomi']= mb_convert_kana(mb_convert_kana($middleyomi), "c");
    $addr['lastname']  = $lastname;
    $addr['lastyomi']  = mb_convert_kana(mb_convert_kana($lastyomi), "c");
    //$addr['nickname']  = $nickname;
    $addr['division']  = $division;
    $addr['title']     = $title;
    $addr['company']   = $company;
    $addr['compyomi']  = mb_convert_kana(mb_convert_kana($compyomi), "c");
    $addr['country']   = $country;
    $addr['zip']       = $zip;
    $addr['prefecture']= $prefecture;
    $addr['city']      = $city;
    $addr['address']   = $address;
    //$addr['home']      = $home;
    $addr['mobile']    = $mobile;
    $addr['work']      = $work;
    $addr['fax']       = $fax;
    $addr['email']     = $email;
    //$addr['email2']    = $email2;
    //$addr['email3']    = $email3;
    $addr['homepage']  = $homepage;
    $addr['bday']      = $bday;
    $addr['bmonth']    = $bmonth;
    $addr['byear']     = $byear;
    //$addr['aday']      = $aday;
    //$addr['amonth']    = $amonth;
    //$addr['ayear']     = $ayear;
    //$addr['address2']  = $address2;
    //$addr['phone2']    = $phone2;
    $addr['notes']     = $notes;

    if (isset($_FILES["photo"]) && $_FILES["photo"]["error"] <= 0) {

      $file_tmp_name = $_FILES["photo"]["tmp_name"];
      $file_name     = $_FILES["photo"]["name"];
      $photo = new Photo($file_tmp_name);
      $photo->scaleToMaxSide(1024);
      $addr['photo'] = $photo->getBase64();

    }

    if (isset($_FILES["back"]) && $_FILES["back"]["error"] <= 0) {

      $file_tmp_name = $_FILES["back"]["tmp_name"];
      $file_name     = $_FILES["back"]["name"];
      $photo = new Photo($file_tmp_name);
      $photo->scaleToMaxSide(1024);
      $addr['back'] = $photo->getBase64();

    }

    $g_name = "";
    if($table_groups != "" ) {
      if( !$is_fix_group ) {
        $g_name = $new_group;
      } else {
        $g_name = $group_name;
      }
    }
    saveAddress($addr, $g_name);

    echo "<br /><div class='msgbox'>Information entered into address book.";
    echo "<br /><i><a href='edit$page_ext'>add next</a> or return to <a href='index$page_ext'>home page</a>.</i></div>";

  } else {
    echo "<br /><div class='msgbox'>Editing is disabled.</div>\n";
  }
}
else if($update)
{
  if(! $read_only)
  {
    $addr['id']        = $id;
    $addr['user_id']   = $user_id;
    $addr['firstname'] = $firstname;
    $addr['firstyomi'] = $firstyomi;
    $addr['middlename']= $middlename;
    $addr['middleyomi']= $middleyomi;
    $addr['lastname']  = $lastname;
    $addr['lastyomi']  = $lastyomi;
    //$addr['nickname']  = $nickname;
    $addr['division']  = $division;
    $addr['title']     = $title;
    $addr['company']   = $company;
    $addr['compyomi']  = $compyomi;
    $addr['country']   = $country;
    $addr['zip']       = $zip;
    $addr['prefecture']= $prefecture;
    $addr['city']      = $city;
    $addr['address']   = $address;
    //$addr['home']      = $home;
    $addr['mobile']    = $mobile;
    $addr['work']      = $work;
    $addr['fax']       = $fax;
    $addr['email']     = $email;
    //$addr['email2']    = $email2;
    //$addr['email3']    = $email3;
    $addr['homepage']  = $homepage;
    $addr['bday']      = $bday;
    $addr['bmonth']    = $bmonth;
    $addr['byear']     = $byear;
    //$addr['aday']      = $aday;
    //$addr['amonth']    = $amonth;
    //$addr['ayear']     = $ayear;
    //$addr['address2']  = $address2;
    //$addr['phone2']    = $phone2;
    $addr['notes']     = $notes;

    $keep_photo = true;
    if(isset($delete_photo)) {
      $keep_photo =  !$delete_photo;
    }
    if(isset($delete_back)) {
      $keep_back =  !$delete_back;
    }

    if(isset($_FILES["photo"])
          && $_FILES["photo"]["error"] <= 0) {

      $file_tmp_name = $_FILES["photo"]["tmp_name"];
      $file_name     = $_FILES["photo"]["name"];
      $photo = new Photo($file_tmp_name);
      $photo->scaleToMaxSide(1024);
      $addr['photo'] = $photo->getBase64();
      //$keep_photo = false;
    } else  {
      $addr['photo']  = $photo_hidden;
    }

    $keep_back = true;
    if(isset($delete_back)) {
      $keep_back =  !$delete_back;
    }

    if(isset($_FILES["back"])
          && $_FILES["back"]["error"] <= 0) {

      $file_tmp_name = $_FILES["back"]["tmp_name"];
      $file_name     = $_FILES["back"]["name"];
      $photo = new Photo($file_tmp_name);
      $photo->scaleToMaxSide(1024);
      $addr['back'] = $photo->getBase64();
      //$keep_photo = false;
    } else  {
      $addr['back']  = $back_hidden;
    }

    if(updateAddress($addr, $keep_photo, $keep_back)) { ?>
      <br /><div class='msgbox'><?php echo ucfmsg('ADDRESS_BOOK')." ".msg('UPDATED') ?><br /><i>return to <a href='index<?php echo $page_ext ?>'>home page</a></i></div>
<?php
    } else { ?>
      <br /><div class='msgbox'><?php echo ucfmsg('INVALID') ?> ID.<br /><i>return to <a href='index<?php echo $page_ext ?>'>home page</a></i></div>
<?php
    }
  } else { ?>
    <br /><div class='msgbox'>Editing is disabled.</div>
<?php
  }
}
else if($id)
{
  if(! $read_only)
  {
    //$result = mysqli_query($db,"SELECT * FROM $base_from_where AND $table.id=$id");
    $sql = "SELECT $base_select FROM $base_from_where AND $table.n_card='$id'";
    $result = mysqli_query($db,$sql);
    $myrow = mysqli_fetch_array($result);
?>
  <script type="text/javascript" src="./js/utils.js"></script>
  <script type="text/javascript" src="./js/sns.js"></script>
  <script type="text/javascript">
  $(document).ready(function(ev) {
    var twitterChanged = function() {
      var screen = $("#twitter_screen").val();
      var follow_twitter = JSON.parse(localStorage.getItem("follow_twitter"));
      if (follow_twitter && typeof follow_twitter == "object") {
        for (var i = 0; i < follow_twitter.length; ++i) {
          var follow = follow_twitter[i];
          if (follow.screen && follow.screen == screen) {
            followTwitterSeccess();
            break;
          }
        }
      }
    }
    $('#twitter_screen').change(function() {
      twitterChanged();
    });
    twitterChanged();
  });
  function followTwitterSeccess() {
    var btn = $("#twitter_action");
    btn.html("フォロー済");
    btn.disable();
  }
  </script>

  <form enctype="multipart/form-data"
        accept-charset="utf-8"
        method="post"
        action="edit<?php echo $page_ext; ?>">

    <input type="submit" name="update" value="<?php echo ucfmsg('UPDATE') ?>" /><br />

    <input type="hidden" name="id" value="<?php echo isset($myrow['id']) ? $myrow['id'] : ''; ?>" />
    <input type="hidden" name="photo_hidden" value="<?php echo $myrow['photo'] ?>" />
    <input type="hidden" name="back_hidden" value="<?php echo $myrow['back'] ?>" />

    <label>登録先:</label>
    <select name="userid">
      <?php
        $admin = $login->getAdmin();
        $user = $login->getUser();
        $name = $user->getName();
        $id = $user->getId();
      ?>
      <option value="<?php echo $admin ?>"<?php echo $id==$admin?" selected":""?>>共用</option>
      <option value="<?php echo $id ?>"<?php echo $id!=$admin&&$id==$myrow['user_id']?" selected":""?>><?php echo $name ?></option>
    </select><br /><br />

    <label><?php echo ucfmsg("LASTNAME") ?>:</label>
    <input type="text" name="lastname" size="35" value="<?php echo $myrow['lastname']?>" /><br />

    <label>よみ:</label>
    <input type="text" name="lastyomi" size="35" value="<?php echo $myrow['lastyomi']?>" /><br />

    <label><?php echo ucfmsg("MIDDLENAME") ?>:</label>
    <input type="text" name="middlename" size="15" value="<?php echo $myrow['middlename']?>" /><br />

    <label>よみ:</label>
    <input type="text" name="middleyomi" size="35" value="<?php echo $myrow['middleyomi']?>" /><br />

    <label><?php echo ucfmsg("FIRSTNAME") ?>:</label>
    <input type="text" name="firstname" size="35" value="<?php echo $myrow['firstname']?>" /><br />

    <label>よみ:</label>
    <input type="text" name="firstyomi" size="35" value="<?php echo $myrow['firstyomi']?>" /><br />
<!--
    <label><?php //echo ucfmsg("NICKNAME") ?>:</label>
    <input type="text" name="nickname" size="35" value="<?php //echo $myrow['nickname']?>" /><br />
-->
    <label>&nbsp;</label><br /><br class="clear" />

    <?php
      function getPhotoImg($photo, $alt, $id) {
        $b64 = explode(";", $photo);
        if(count($b64) == 1) {
          $b64 = str_replace(" ", "", $b64[0]);
          return ($photo != "" ? '<img id="'.$id.'" alt="'.$alt.'" width=240 src="data:image/jpg;base64,'.$b64.'" /><br />' : '<img id="'.$id.'" alt="'.$alt.'" width=240 style="visibility:hidden" /><br />');
        } else if(count($b64) >= 3) {
          $b64 = $b64[2];
          $b64 = explode(":", $b64);
          if(count($b64) >= 2) {
            $b64 = str_replace(" ", "", $b64[1]);
            return ($photo != "" ? '<img id="'.$id.'" alt="'.$alt.'" width=240 src="data:image/jpg;base64,'.$b64.'" /><br />' : '<img id="'.$id.'" alt="'.$alt.'" width=240 style="visibility:hidden" /><br />');
          }
        } else {
          return '<img id="'.$id.'" alt="'.$alt.'" width=240 style="visibility:hidden" /><br />';
        }
      }
    ?>
    <label>名刺（表）:</label>
    <?php echo getPhotoImg(str_replace(" ", "", $myrow['photo']), "名刺（表）", "front_image")."\n" ?>
    <label>　</label>
    <input type="file" id="photo" name="photo" /><br />

    <label><?php echo msg("DELETE") ?>:</label>
    <input type="checkbox" name="delete_photo" /><br />

    <label>&nbsp;</label><br /><br class="clear" />

    <label>名刺（裏）:</label>
    <?php echo getPhotoImg(str_replace(" ", "", $myrow['back']), "名刺（裏）", "back_image") ?>
    <label>　</label>
    <input type="file" id="back" name="back" /><br />

    <label><?php echo msg("DELETE") ?>:</label>
    <input type="checkbox"  name="delete_back" /><br />

    <label>&nbsp;</label><br /><br class="clear" />

    <label><?php echo ucfmsg("COMPANY") ?>:</label>
    <input type="text" name="company" size="35" value="<?php echo $myrow['company']?>" /><br />

    <label>よみ:</label>
    <input type="text" name="compyomi" size="35" value="<?php echo $myrow['compyomi']?>" /><br />

    <label><?php echo ucfmsg("DEPT") ?>:</label>
    <input type="text" name="division" size="35" value="<?php echo $myrow['division']?>" /><br />

    <label><?php echo ucfmsg("TITLE") ?>:</label>
    <input type="text" name="title" size="35" value="<?php echo $myrow['title']?>" /><br />

    <label>&nbsp;</label><br /><br class="clear" />

    <label><?php echo ucfmsg("COUNTRY") ?>:</label>
    <input type="text" name="country" size="35" value="<?php echo $myrow['country']?>" /><br />

    <label><?php echo ucfmsg("ZIP") ?>:</label>
    <input type="text" name="zip" size="35" value="<?php echo $myrow['zip']?>" /><br />

    <label>都道府県:</label>
    <input type="text" name="prefecture" size="35" value="<?php echo $myrow['prefecture']?>" /><br />

    <label>市町村:</label>
    <input type="text" name="city" size="35" value="<?php echo $myrow['city']?>" /><br />

    <label><?php echo ucfmsg("ADDRESS") ?>:</label>
    <input type="text" name="address" size="35" value="<?php echo $myrow['number']?>" /><br />
<!--
    <textarea name="address" rows="5" cols="35"><?php //echo $myrow["address"]?></textarea><br />
-->

    <label>&nbsp;</label><br /><br class="clear" />
<!--
    <label><?php //echo ucfmsg("TELEPHONE") ?></label><br /><br class="clear" />

    <label><?php //echo ucfmsg("PHONE_HOME") ?>:</label>
    <input type="text" name="home" value="<?php //echo $myrow['home']?>" /><br />
-->
    <label><?php echo ucfmsg("PHONE_MOBILE") ?>:</label>
    <input type="text" name="mobile" value="<?php echo $myrow['mobile']?>" /><br />

    <label><?php echo ucfmsg("PHONE_WORK") ?>:</label>
    <input type="text" name="work" value="<?php echo $myrow['work']?>" /><br />

    <label><?php echo ucfmsg("FAX") ?>:</label>
    <input type="text" name="fax" value="<?php echo $myrow['fax']?>" /><br />

    <label>&nbsp;</label><br /><br class="clear" />

    <label><?php echo ucfmsg("EMAIL") ?>:</label>
    <input type="text" name="email" size="35" value="<?php echo $myrow['email']?>" /><br />
<!--
    <label><?php //echo ucfmsg("EMAIL") ?>2:</label>
    <input type="text" name="email2" size="35" value="<?php //echo $myrow['email2']?>" /><br />

    <label><?php //echo ucfmsg("EMAIL") ?>3:</label>
    <input type="text" name="email3" size="35" value="<?php //echo $myrow['email3']?>" /><br />
-->
    <label><?php echo ucfmsg("HOMEPAGE") ?>:</label>
    <input type="text" name="homepage" size="35" value="<?php echo $myrow['homepage']?>" /><br />

    <label>Twitter:</label>
    <input type="text" id="twitter_screen" name="twitter" size="35" value="<?php echo $myrow['twitter']?>" />
    <button id="twitter_action" onclick="loginTwitter(document.getElementById('twitter_screen').value, followTwitterSeccess); return false">フォロー</button><br />

    <label>Facebook:</label>
    <input type="text" name="facebook" size="35" value="<?php echo $myrow['facebook']?>" />
    <button id="facebook_action" onclick="return false">友達申請</button><br />

    <label>LINE:</label>
    <input type="text" name="line" size="35" value="<?php echo $myrow['line']?>" />
    <button id="line_action" onclick="return false">友達申請</button><br />

    <label><?php echo ucfmsg("BIRTHDAY") ?>:</label>
    <input class="byear" type="text" name="byear" size="4" maxlength="4" value="<?php echo $myrow['byear']?>" />年
    <select name="bmonth">
      <option value="<?php echo $myrow['bmonth_num'] ?>" selected="selected"><?php echo ucfmsg(strtoupper($myrow["bmonth_num"])); ?></option>
      <option value="-">-</option>
      <option value="January"><?php echo ucfmsg("JANUARY") ?></option>
      <option value="February"><?php echo ucfmsg("FEBRUARY") ?></option>
      <option value="March"><?php echo ucfmsg("MARCH") ?></option>
      <option value="April"><?php echo ucfmsg("APRIL") ?></option>
      <option value="May"><?php echo ucfmsg("MAY") ?></option>
      <option value="June"><?php echo ucfmsg("JUNE") ?></option>
      <option value="July"><?php echo ucfmsg("JULY") ?></option>
      <option value="August"><?php echo ucfmsg("AUGUST") ?></option>
      <option value="September"><?php echo ucfmsg("SEPTEMBER") ?></option>
      <option value="October"><?php echo ucfmsg("OCTOBER") ?></option>
      <option value="November"><?php echo ucfmsg("NOVEMBER") ?></option>
      <option value="December"><?php echo ucfmsg("DECEMBER") ?></option>
    </select>
    <select name="bday">
      <option value="<?php echo $myrow['bday']?>" selected="selected"><?php echo ($myrow["bday"] == 0?"-":$myrow["bday"]) ?></option>
      <option value="0">-</option>
      <option value="1">1</option>
      <option value="2">2</option>
      <option value="3">3</option>
      <option value="4">4</option>
      <option value="5">5</option>
      <option value="6">6</option>
      <option value="7">7</option>
      <option value="8">8</option>
      <option value="9">9</option>
      <option value="10">10</option>
      <option value="11">11</option>
      <option value="12">12</option>
      <option value="13">13</option>
      <option value="14">14</option>
      <option value="15">15</option>
      <option value="16">16</option>
      <option value="17">17</option>
      <option value="18">18</option>
      <option value="19">19</option>
      <option value="20">20</option>
      <option value="21">21</option>
      <option value="22">22</option>
      <option value="23">23</option>
      <option value="24">24</option>
      <option value="25">25</option>
      <option value="26">26</option>
      <option value="27">27</option>
      <option value="28">28</option>
      <option value="29">29</option>
      <option value="30">30</option>
      <option value="31">31</option>
    </select>日<br />
<!--
    <label><?php //echo ucfmsg("ANNIVERSARY") ?>:</label>
        <select name="aday">
      <option value="<?php //echo $myrow['aday']?>" selected="selected"><?php //echo ($myrow["aday"] == 0?"-":$myrow["aday"]) ?></option>
          <option value="0">-</option>
          <option value="1">1</option>
          <option value="2">2</option>
          <option value="3">3</option>
          <option value="4">4</option>
          <option value="5">5</option>
          <option value="6">6</option>
          <option value="7">7</option>
          <option value="8">8</option>
          <option value="9">9</option>
          <option value="10">10</option>
          <option value="11">11</option>
          <option value="12">12</option>
          <option value="13">13</option>
          <option value="14">14</option>
          <option value="15">15</option>
          <option value="16">16</option>
          <option value="17">17</option>
          <option value="18">18</option>
          <option value="19">19</option>
          <option value="20">20</option>
          <option value="21">21</option>
          <option value="22">22</option>
          <option value="23">23</option>
          <option value="24">24</option>
          <option value="25">25</option>
          <option value="26">26</option>
          <option value="27">27</option>
          <option value="28">28</option>
          <option value="29">29</option>
          <option value="30">30</option>
          <option value="31">31</option>
        </select>
        <select name="amonth">
          <option value="<?php //echo $myrow['amonth'] ?>" selected="selected"><?php //echo ucfmsg(strtoupper($myrow["amonth"])); ?></option>
          <option value="-">-</option>
          <option value="january"><?php //echo ucfmsg("january") ?></option>
          <option value="february"><?php //echo ucfmsg("february") ?></option>
          <option value="march"><?php //echo ucfmsg("march") ?></option>
          <option value="april"><?php //echo ucfmsg("april") ?></option>
          <option value="may"><?php //echo ucfmsg("may") ?></option>
          <option value="june"><?php //echo ucfmsg("june") ?></option>
          <option value="july"><?php //echo ucfmsg("july") ?></option>
          <option value="august"><?php //echo ucfmsg("august") ?></option>
          <option value="september"><?php //echo ucfmsg("september") ?></option>
          <option value="october"><?php //echo ucfmsg("october") ?></option>
          <option value="november"><?php //echo ucfmsg("november") ?></option>
          <option value="december"><?php //echo ucfmsg("december") ?></option>
        </select>
        <input class="byear" type="text" name="ayear" size="4" maxlength="4" value="<?php //echo $myrow['ayear']?>" /><br />
-->
<?php
/* Group handling on change
      <label><?php echo ucfmsg("GROUP") ?>:</label>
        <?php
        if(isset($table_groups) and $table_groups != "" and !$is_fix_group) { ?>
        <select name="new_group">
        <?php
          if($group_name != "")
          {
            echo "<option>$group_name</option>\n";
          }
          $sql = "SELECT group_name FROM $table_groups ORDER BY lower(group_name) ASC";
          $result_groups = mysqli_query($db,$sql);
          $result_gropup_snumber = mysqli_num_rows($result_groups);

          while ($myrow_group = mysqli_fetch_array($result_groups))
          {
            echo "<option>".$myrow_group["group_name"]."</option>\n";
          }
        ?>
        </select>
        <?php } ?>
      <br />
 */ ?>
<!--
    <br />
    <label><b><?php //echo ucfmsg("SECONDARY") ?></b></label><br /><br class="clear" />

    <label><?php //echo ucfmsg("ADDRESS") ?>:</label>
    <textarea name="address2" rows="5" cols="35"><?php //echo $myrow["address2"]?></textarea><br />

    <label><?php //echo ucfmsg("PHONE_HOME") ?>:</label>
    <input type="text" name="phone2" value="<?php //echo $myrow['phone2']?>" /><br />
-->
    <label><?php echo ucfmsg("NOTES") ?>:</label>
    <textarea name="notes" rows="5" cols="35"><?php echo $myrow["notes"]?></textarea><br /><br />

    <input type="submit" name="update" value="<?php echo ucfmsg('UPDATE') ?>" />
  </form>
  <form method="get" action="delete<?php echo $page_ext; ?>">
    <input type="hidden" name="id" value="<?php echo $myrow['id']?>" />
    <input type="submit" name="update" value="<?php echo ucfmsg('DELETE') ?>" />
  </form>
  <script type="text/javascript">
    var front_text = document.getElementById('photo');
    front_text.addEventListener('change', function(e){
      var reader = new FileReader();
      reader.onload = function (e) {
        var image = document.getElementById('front_image');
        image.setAttribute('src', e.target.result);
        image.style.visibility = 'visible';
      }
      reader.readAsDataURL(e.target.files[0]);
    });

    var back_text = document.getElementById('back');
    back_text.addEventListener('change', function(e){
      var reader = new FileReader();
      reader.onload = function (e) {
        var image = document.getElementById('back_image');
        image.setAttribute('src', e.target.result);
        image.style.visibility = 'visible';
      }
      reader.readAsDataURL(e.target.files[0]);
    });
  </script>
<?php
} else { ?>
    <br /><div class='msgbox'>Editing is disabled.</div>
<?php
  }
}
/*
else if( !(isset($_POST['quickskip']) || isset($_POST['quickadd']))
       && (isset($_GET['quickadd']) || isset($_POST['quickadd']) || $quickadd))
{
?>
<!--
  <form accept-charset="utf-8" method="post" name="quickadd" >
    <input type="submit" name="quickadd"  value="<?php echo ucfmsg('NEXT') ?>" /><br/><br/>

    <label><?php echo ucfmsg("ADDRESS") ?>:</label>
    <textarea name="address" rows="20" tabindex="0"></textarea><br/><br/>
    <input type="submit" name="quickadd"  value="<?php echo ucfmsg('NEXT') ?>" /><br/>
  </form>
  <script type="text/javascript">
	  document.quickadd.address.focus();
  </script>
-->
<?php
}
*/
else
{
  if(! $read_only)
  {
    if(isset($_POST['quickadd'])) {

      include_once("include/guess.inc.php");
      $addr = guessAddressFields($address);
      // echo nl2br(print_r($addr, true));
    } else {
      $addr = array();
    }
?>
<script type="text/javascript" src="./js/utils.js"></script>
<script type="text/javascript" src="./edit.js"></script>
<script type="text/javascript">
<!--

last_proposal = "";

function proposeMail() {

  if(document.theform.email.value == last_proposal) {

    new_proposal = "";

    has_firstname = document.theform.firstname.value != "";
    has_middlename = document.theform.middlename.value != "";
    has_lastname  = document.theform.lastname.value  != "";

    if(has_firstname) {
      new_proposal = document.theform.firstname.value.toLowerCase().replace(/^\s+|\s+$/g, '');
    }
    if(has_firstname && (has_middlename || has_lastname)) {
      new_proposal += ".";
    }
    if(has_lastname) {
      new_proposal += document.theform.lastname.value.toLowerCase().replace(/^\s+|\s+$/g, '');
    }
    if(has_middlename) {
      new_proposal += document.theform.middlename.value.toLowerCase().replace(/^\s+|\s+$/g, '');
    }
    if(has_middlename && has_lastname) { // middlename cannot exsist without lastname in Dutch
      new_proposal += ".";
    }
    new_proposal += "@" + document.theform.company.value.toLowerCase().replace(/^\s+|\s+$/g, '');

    new_proposal = new_proposal.replace(/ /g, "-");
    document.theform.email.value = new_proposal;
    last_proposal = new_proposal;

  }
}
function ucfirst(str) {
  return str.slice(0,1).toUpperCase() + str.slice(1);
}
function ucf_arr(str_arr) {
  str_res = Array();
  for (var i = 0; i < str_arr.length; i++) {
    str_res[i] = ucfirst(str_arr[i]);
  }
  return str_res;
}

function trim(str, chars) {
  no_left = str.replace(new RegExp("^[" + chars + "]+", "g"), "");
  return no_left.replace(new RegExp("[" + chars + "]+$", "g"), "");
}

function proposeNames() {

  document.theform.email.value = trim(document.theform.email.value, " \t");
  who_from = document.theform.email.value.split("@", 2);

  if(who_from.length >= 2) {

    who  = who_from[0].split(/[\._]+/,2);
    if(who.length == 1)  {
      who  = who_from[0].split("_",2);
    }
    if(document.theform.firstname.value == "") {
      document.theform.firstname.value = ucf_arr(who[0].split("-")).join("-");
    }
    if(who.length > 1 && document.theform.lastname.value == "") {
      document.theform.lastname.value = ucf_arr(who[1].split("-")).join("-");
    }
  }
}
-->
</script>

  <form name="theform"
        enctype="multipart/form-data"
        accept-charset="utf-8"
        method="post"
        action="edit<?php echo $page_ext; ?>">

    <input type="submit" name="submit" value="<?php echo ucfmsg('ENTER') ?>" /><br /><br />

    <input type="hidden" name="id" value="<?php echo echoIfSet($addr, 'id') ?>" />

    <label>登録先:</label>
    <select name="userid">
      <?php
        $admin = $login->getAdmin();
        $user = $login->getUser();
        $name = $user->getName();
        $id = $user->getId();
      ?>
      <option value="<?php echo $admin ?>" selected>共用</option>
      <option value="<?php echo $id ?>"><?php echo $name ?></option>
    </select><br /><br />

    <label><?php echo ucfmsg("LASTNAME") ?>:</label>
    <input type="text" name="lastname"  value="<?php echoIfSet($addr, 'lastname') ?>"  size="35" onkeyup="proposeMail()"/><br />
    <label>よみ:</label>
    <input type="text" name="lastyomi"  value="<?php echoIfSet($addr, 'lastyomi') ?>"  size="35"/><br />

    <label><?php echo ucfmsg("MIDDLENAME") ?>:</label>
    <input type="text" name="middlename" value="<?php echoIfSet($addr, 'middlename') ?>" size="15" onkeyup="proposeMail()"/><br />
    <label>よみ:</label>
    <input type="text" name="middleyomi" value="<?php echoIfSet($addr, 'middleyomi') ?>" size="15"/><br />

    <label><?php echo ucfmsg("FIRSTNAME") ?>:</label>
    <input type="text" name="firstname" value="<?php echoIfSet($addr, 'firstname') ?>" size="35" onkeyup="proposeMail()"/><br />
    <label>よみ:</label>
    <input type="text" name="firstyomi" value="<?php echoIfSet($addr, 'firstyomi') ?>" size="35"/><br />

    <label>&nbsp;</label><br /><br class="clear" />

<!--
    <label><?php //echo ucfmsg("NICKNAME") ?>:</label>
    <input type="text" name="nickname"  value="<?php //echoIfSet($addr, 'nickname'); ?>"  size="35"/><br />
-->

    <label>名刺（表）:</label>
    <img id="front_image" alt="名刺（表）" style="visibility:hidden" width=240><br />
    <label>　</label>
    <input type="file" id="photo" name="photo" /><br /><br />
    <label>名刺（裏）:</label>
    <img id="back_image" alt="名刺（裏）" style="visibility:hidden" width=240><br />
    <label>　</label>
    <input type="file" id="back" name="back" /><br />

    <label>&nbsp;</label><br /><br class="clear" />

    <label><?php echo ucfmsg("COMPANY") ?>:</label>
    <input type="text" name="company"   value="<?php echoIfSet($addr, 'company') ?>"   size="35" onkeyup="proposeMail()"/><br />
    <label>よみ:</label>
    <input type="text" name="compyomi"   value="<?php echoIfSet($addr, 'compyomi') ?>"   size="35"/><br />

    <label><?php echo ucfmsg("DEPT") ?>:</label>
    <input type="text" name="division" size="35" value="<?php echoIfSet($addr, 'division') ?>" /><br />

    <label><?php echo ucfmsg("TITLE") ?>:</label>
    <input type="text" name="title" size="35" value="<?php echoIfSet($addr, 'title') ?>" /><br />

    <label>&nbsp;</label><br /><br class="clear" />

    <label><?php echo ucfmsg("COUNTRY") ?>:</label>
    <input type="text" name="country" size="35" value="<?php echoIfSet($addr, 'country') ?>" /><br />

    <label><?php echo ucfmsg("ZIP") ?>:</label>
    <input type="text" name="zip" size="35" value="<?php echoIfSet($addr, 'zip') ?>" /><br />

    <label>都道府県:</label>
    <input type="text" name="prefecture" size="35" value="<?php echoIfSet($addr, 'prefecture') ?>" /><br />

    <label>市町村:</label>
    <input type="text" name="city" size="35" value="<?php echoIfSet($addr, 'city') ?>" /><br />

    <label><?php echo ucfmsg("ADDRESS") ?>:</label>
    <input type="text" name="address" size="35" value="<?php echoIfSet($addr, 'number') ?>" /><br />

<!--
    <label><?php //echo ucfmsg("ADDRESS") ?>:</label>
    <textarea name="address" rows="5" cols="35"><?php //echoIfSet($addr, 'address'); ?></textarea><br />

    <label><?php //echo ucfmsg("TELEPHONE") ?></label><br /><br class="clear" />

    <label><?php //echo ucfmsg("PHONE_HOME") ?>:</label>
    <input type="text" name="home"      value="<?php //echoIfSet($addr, 'home'); ?>"    size="35" /><br />
-->
    <label><?php echo ucfmsg("PHONE_MOBILE") ?>:</label>
    <input type="text" name="mobile"    value="<?php echoIfSet($addr, 'mobile') ?>"  size="35" /><br />

    <label><?php echo ucfmsg("PHONE_WORK") ?>:</label>
    <input type="text" name="work"      value="<?php echoIfSet($addr, 'work') ?>" size="35" /><br />

    <label><?php echo ucfmsg("FAX") ?>:</label>
    <input type="text" name="fax"       value="<?php echoIfSet($addr, 'fax') ?>" size="35" /><br />

    <label>&nbsp;</label><br /><br class="clear" />

    <label><?php echo ucfmsg("EMAIL") ?>:</label>
    <input type="text" name="email"     value="<?php echoIfSet($addr, 'email') ?>" size="35" onkeyup="proposeNames()"/><br />
<!--
    <label><?php //echo ucfmsg("EMAIL") ?>2:</label>
    <input type="text" name="email2"    value="<?php //echoIfSet($addr, 'email2'); ?>" size="35" /><br />

    <label><?php //echo ucfmsg("EMAIL") ?>3:</label>
    <input type="text" name="email3"    value="<?php //echoIfSet($addr, 'email3'); ?>" size="35" /><br />
-->
    <label><?php echo ucfmsg("HOMEPAGE") ?>:</label>
    <input type="text" name="homepage"  value="<?php echoIfSet($addr, 'homepage') ?>" size="35" /><br />

    <label>Twitter:</label>
    <input type="text" name="twitter" size="35" value="<?php echoIfSet($addr, 'twitter') ?>" /><br />

    <label>Facebook:</label>
    <input type="text" name="facebook" size="35" value="<?php echoIfSet($addr, 'facebook') ?>" /><br />

    <label>LINE:</label>
    <input type="text" name="line" size="35" value="<?php echoIfSet($addr, 'line') ?>" /><br />

    <label><?php echo ucfmsg("BIRTHDAY") ?>:</label>
    <input class="byear" type="text" name="byear" size="4" maxlength="4" value="<?php echoIfSet($addr, 'byear') ?>"/>年
    <select name="bmonth">
<?php
    if(isset($addr['bmonth'])) { ?>
      <option value="<?php echoIfSet($addr, 'bmonth') ?>" selected="selected">
        <?php echo ucfmsg(strtoupper($addr['bmonth'])) ?>
     </option>
<?php
    } ?>
      <option value="-">-</option>
      <option value="January"><?php echo ucfmsg("JANUARY") ?></option>
      <option value="February"><?php echo ucfmsg("FEBRUARY") ?></option>
      <option value="March"><?php echo ucfmsg("MARCH") ?></option>
      <option value="April"><?php echo ucfmsg("APRIL") ?></option>
      <option value="May"><?php echo ucfmsg("MAY") ?></option>
      <option value="June"><?php echo ucfmsg("JUNE") ?></option>
      <option value="July"><?php echo ucfmsg("JULY") ?></option>
      <option value="August"><?php echo ucfmsg("AUGUST") ?></option>
      <option value="September"><?php echo ucfmsg("SEPTEMBER") ?></option>
      <option value="October"><?php echo ucfmsg("OCTOBER") ?></option>
      <option value="November"><?php echo ucfmsg("NOVEMBER") ?></option>
      <option value="December"><?php echo ucfmsg("DECEMBER") ?></option>
    </select>
    <select name="bday">
      <option value="<?php echoIfSet($addr, 'bday') ?>" selected="selected"><?php echoIfSet($addr, 'bday') ?></option>
      <option value="0">-</option>
      <option value="1">1</option>
      <option value="2">2</option>
      <option value="3">3</option>
      <option value="4">4</option>
      <option value="5">5</option>
      <option value="6">6</option>
      <option value="7">7</option>
      <option value="8">8</option>
      <option value="9">9</option>
      <option value="10">10</option>
      <option value="11">11</option>
      <option value="12">12</option>
      <option value="13">13</option>
      <option value="14">14</option>
      <option value="15">15</option>
      <option value="16">16</option>
      <option value="17">17</option>
      <option value="18">18</option>
      <option value="19">19</option>
      <option value="20">20</option>
      <option value="21">21</option>
      <option value="22">22</option>
      <option value="23">23</option>
      <option value="24">24</option>
      <option value="25">25</option>
      <option value="26">26</option>
      <option value="27">27</option>
      <option value="28">28</option>
      <option value="29">29</option>
      <option value="30">30</option>
      <option value="31">31</option>
    </select>日<br />
<!--
        <label><?php //echo ucfmsg("ANNIVERSARY") ?>:</label>
        <select name="aday">
          <option value="<?php //echoIfSet($addr, 'aday'); ?>" selected="selected"><?php //echoIfSet($addr, 'aday'); ?></option>
          <option value="0">-</option>
          <option value="1">1</option>
          <option value="2">2</option>
          <option value="3">3</option>
          <option value="4">4</option>
          <option value="5">5</option>
          <option value="6">6</option>
          <option value="7">7</option>
          <option value="8">8</option>
          <option value="9">9</option>
          <option value="10">10</option>
          <option value="11">11</option>
          <option value="12">12</option>
          <option value="13">13</option>
          <option value="14">14</option>
          <option value="15">15</option>
          <option value="16">16</option>
          <option value="17">17</option>
          <option value="18">18</option>
          <option value="19">19</option>
          <option value="20">20</option>
          <option value="21">21</option>
          <option value="22">22</option>
          <option value="23">23</option>
          <option value="24">24</option>
          <option value="25">25</option>
          <option value="26">26</option>
          <option value="27">27</option>
          <option value="28">28</option>
          <option value="29">29</option>
          <option value="30">30</option>
          <option value="31">31</option>
        </select>
        <select name="amonth">
     <?php   //if(isset($addr['amonth'])) { ?>
          <option value="<?php //echoIfSet($addr, 'amonth'); ?>" selected="selected"><?php
           //echo ucfmsg(strtoupper($addr['amonth'])); ?></option>
     <?php //} ?>
          <option value="-">-</option>
          <option value="January"><?php //echo ucfmsg("JANUARY") ?></option>
          <option value="February"><?php //echo ucfmsg("FEBRUARY") ?></option>
          <option value="March"><?php //echo ucfmsg("MARCH") ?></option>
          <option value="April"><?php //echo ucfmsg("APRIL") ?></option>
          <option value="May"><?php //echo ucfmsg("MAY") ?></option>
          <option value="June"><?php //echo ucfmsg("JUNE") ?></option>
          <option value="July"><?php //echo ucfmsg("JULY") ?></option>
          <option value="August"><?php //echo ucfmsg("AUGUST") ?></option>
          <option value="September"><?php //echo ucfmsg("SEPTEMBER") ?></option>
          <option value="October"><?php //echo ucfmsg("OCTOBER") ?></option>
          <option value="November"><?php //echo ucfmsg("NOVEMBER") ?></option>
          <option value="December"><?php //echo ucfmsg("DECEMBER") ?></option>
        </select>
        <input class="byear" type="text" name="ayear" size="4" maxlength="4" value="<?php //echoIfSet($addr, 'ayear'); ?>"/><br />
-->
    <?php
    if($table_groups != "" and !$is_fix_group) { ?>

      <label><?php echo ucfmsg("GROUP") ?>:</label>
        <select name="new_group">
        <?php
          if($group_name != "")
          {
            echo "<option>$group_name</option>\n";
          } ?>
          <option value="[none]">[<?php echo msg("NONE"); ?>]</option>
          <?php
          $sql="SELECT group_name FROM $groups_from_where ORDER BY lower(group_name) ASC";
          $result_groups = mysqli_query($db,$sql);
          $result_gropup_snumber = mysqli_num_rows($result_groups);

          while ($myrow_group = mysqli_fetch_array($result_groups))
          {
            echo "<option>".$myrow_group["group_name"]."</option>\n";
          }
        ?>
        </select><br />
    <?php
    } ?>
<!--
    <br />
    <label><b><?php //echo ucfmsg("SECONDARY") ?></b></label><br /><br class="clear" />

    <label><?php //echo ucfmsg("ADDRESS") ?>:</label>
    <textarea name="address2" rows="5" cols="35"></textarea><br />

    <label><?php //echo ucfmsg("PHONE_HOME") ?>:</label>
    <input type="text" name="phone2"  value="<?php //echoIfSet($addr, 'phone2'); ?>" size="35" /><br />
-->
    <label><?php echo ucfmsg("NOTES") ?>:</label>
    <textarea name="notes" rows="5" cols="35"></textarea><br /><br />

    <input type="submit" name="submit" value="<?php echo ucfmsg('ENTER') ?>" />
  </form>

  <script type="text/javascript">
    document.theform.lastname.focus();

    var front_text = document.getElementById('photo');
    front_text.addEventListener('change', function(e){
      var reader = new FileReader();
      reader.onload = function (e) {
        var image = document.getElementById('front_image');
        image.setAttribute('src', e.target.result);
        image.style.visibility = 'visible';
      }
      reader.readAsDataURL(e.target.files[0]);
    });

    var back_text = document.getElementById('back');
    back_text.addEventListener('change', function(e){
      var reader = new FileReader();
      reader.onload = function (e) {
        var image = document.getElementById('back_image');
        image.setAttribute('src', e.target.result);
        image.style.visibility = 'visible';
      }
      reader.readAsDataURL(e.target.files[0]);
    });
  </script>

<?php
} else { ?>
  <br /><div class='msgbox'>Editing is disabled.</div>
<?php
  }
}
include ("include/footer.inc.php"); ?>
